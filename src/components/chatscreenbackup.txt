import React, { useState, useCallback, useEffect, useMemo, useRef } from 'react'
import { StyleSheet, View, StatusBar, TouchableOpacity, Text, Animated, KeyboardAvoidingView, Platform, Image } from 'react-native'
import { GiftedChat, IMessage, Bubble, InputToolbar, Send } from 'react-native-gifted-chat'
import { useSafeAreaInsets } from 'react-native-safe-area-context'
import { useNavigation } from '@react-navigation/native'
import DatePicker from 'react-native-date-picker'
import Feather from 'react-native-vector-icons/Feather'
import MaterialIcons from 'react-native-vector-icons/MaterialIcons'
import { Responsive } from '../utilities/Responsive'
import { Colors } from '../utilities/AppTheme'
import GradientBackground from '../components/GradientBackground'

const STEPS = {
  DATE: 'DATE',
  THEATER: 'THEATER',
  TIME: 'TIME',
  SEATS: 'SEATS',
  CONFIRM: 'CONFIRM'
}

const ChatScreen = ({ route }: any) => {
  const insets = useSafeAreaInsets()
  const navigation = useNavigation<any>()
  const [messages, setMessages] = useState<IMessage[]>([])
  const [isTyping, setIsTyping] = useState(false)
  const [showDatePicker, setShowDatePicker] = useState(false)
  const [selectedDate, setSelectedDate] = useState(new Date())

  const CUSTOM_HEADER_HEIGHT = 50;
  const totalOffset = insets.top + Responsive.spacing[25] + CUSTOM_HEADER_HEIGHT;


  const [bookingState, setBookingState] = useState<any>({
    movieId: route?.params?.movieId || null,
    movieName: route?.params?.movieName || null,
    step: STEPS.DATE,
    selectedDate: null,
    selectedTime: null,
    selectedTheater: null,
    selectedSeats: [],
    totalPrice: 0,
  })

  // Reset booking state when new movie is selected
  useEffect(() => {
    if (route?.params?.movieId) {
      setBookingState({
        movieId: route.params.movieId,
        movieName: route.params.movieName,
        step: STEPS.DATE,
        selectedDate: null,
        selectedTime: null,
        selectedTheater: null,
        selectedSeats: [],
        totalPrice: 0,
      })
    }
  }, [route?.params?.movieId])

  useEffect(() => {
    if (route?.params?.selectedTheater) {
      handleTheaterReturn(route.params.selectedTheater, route.params.selectedTime)
    }
    if (route?.params?.selectedSeats) {
      handleSeatsReturn(route.params.selectedSeats)
    }
  }, [route?.params])

  useEffect(() => {
    const initialMessage = bookingState.movieId
      ? `Great! You've selected "${bookingState.movieName}". Let me help you book tickets.\n\nðŸ“… Please select your preferred date:`
      : 'Hello! I\'m MovieBot, your cinema assistant. I can help you find movies, check showtimes, and book tickets. How can I assist you today?'

    const quickReplies = bookingState.movieId ? {
      type: 'radio',
      keepIt: true,
      values: [{ title: 'ðŸ“… Select Date', value: 'select_date' }]
    } : undefined

    setMessages([
      {
        _id: 1,
        text: initialMessage,
        createdAt: new Date(),
        user: {
          _id: 2,
          name: 'MovieBot',
          avatar: require('../assets/images/BotChat.png'),
        },
        ...(quickReplies && { quickReplies })
      },
    ])
  }, [bookingState.movieId, bookingState.movieName])

  const handleTheaterReturn = (theater: string, time: string) => {
    const userMsg: IMessage = {
      _id: Math.round(Math.random() * 1000000),
      text: `ðŸŽ­ ${theater} at ${time}`,
      createdAt: new Date(),
      user: { _id: 1 },
    }
    setMessages(prev => GiftedChat.append(prev, [userMsg]))

    setTimeout(() => {
      const botMsg: IMessage = {
        _id: Math.round(Math.random() * 1000000),
        text: `Perfect! ${theater} at ${time}\n\nNow let's select your seats:`,
        createdAt: new Date(),
        user: { _id: 2, name: 'MovieBot', avatar: require('../assets/images/BotChat.png') },
        quickReplies: {
          type: 'radio',
          keepIt: true,
          values: [{ title: 'ðŸª‘ Select Seats', value: 'select_seats' }]
        }
      }
      setMessages(prev => GiftedChat.append(prev, [botMsg]))
      setBookingState(prev => ({ ...prev, selectedTheater: theater, selectedTime: time, step: STEPS.SEATS }))
    }, 500)
  }

  const handleSeatsReturn = (seats: string[]) => {
    const totalPrice = seats.length * 250
    const userMsg: IMessage = {
      _id: Math.round(Math.random() * 1000000),
      text: `ðŸª‘ ${seats.length} seats: ${seats.join(', ')}`,
      createdAt: new Date(),
      user: { _id: 1 },
    }
    setMessages(prev => GiftedChat.append(prev, [userMsg]))

    setTimeout(() => {
      const summary = `ðŸ“‹ Booking Summary\n\nðŸŽ¬ ${bookingState.movieName}\nðŸ“… ${bookingState.selectedDate}\nðŸŽ­ ${bookingState.selectedTheater}\nâ° ${bookingState.selectedTime}\nðŸª‘ ${seats.join(', ')}\nðŸ’° â‚¹${totalPrice}\n\nReady to proceed?`
      const botMsg: IMessage = {
        _id: Math.round(Math.random() * 1000000),
        text: summary,
        createdAt: new Date(),
        user: { _id: 2, name: 'MovieBot', avatar: require('../assets/images/BotChat.png') },
        quickReplies: {
          type: 'radio',
          keepIt: true,
          values: [
            { title: 'ðŸ’³ Proceed to Payment', value: 'proceed_payment' },
            { title: 'ðŸ”„ Modify', value: 'modify' }
          ]
        }
      }
      setMessages(prev => GiftedChat.append(prev, [botMsg]))
      setBookingState(prev => ({ ...prev, selectedSeats: seats, totalPrice, step: STEPS.CONFIRM }))
    }, 500)
  }

  const handleDateConfirm = (date: Date) => {
    setShowDatePicker(false)
    const day = String(date.getDate()).padStart(2, '0')
    const month = String(date.getMonth() + 1).padStart(2, '0')
    const year = date.getFullYear()
    const storedFormat = `${day}/${month}/${year}`

    // Display format: Monday, February 16
    const displayFormat = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })

    const userMsg: IMessage = {
      _id: Math.round(Math.random() * 1000000),
      text: `ðŸ“… ${displayFormat}`,
      createdAt: new Date(),
      user: { _id: 1 },
    }
    setMessages(prev => GiftedChat.append(prev, [userMsg]))

    setTimeout(() => {
      const botMsg: IMessage = {
        _id: Math.round(Math.random() * 1000000),
        text: `Perfect! Now select theater for ${displayFormat}:`,
        createdAt: new Date(),
        user: { _id: 2, name: 'MovieBot', avatar: require('../assets/images/BotChat.png') },
        quickReplies: {
          type: 'radio',
          keepIt: true,
          values: [{ title: 'ðŸŽ­ Select Theater', value: 'select_theater' }]
        }
      }
      setMessages(prev => GiftedChat.append(prev, [botMsg]))
      setBookingState(prev => ({ ...prev, selectedDate: storedFormat, step: STEPS.THEATER }))
    }, 500)
  }

  const onQuickReply = useCallback((quickReply: any) => {
    const value = quickReply[0]?.value || ''
    const title = quickReply[0]?.title || ''

    const userMsg: IMessage = {
      _id: Math.round(Math.random() * 1000000),
      text: title,
      createdAt: new Date(),
      user: { _id: 1 },
    }
    setMessages(prev => GiftedChat.append(prev, [userMsg]))

    if (value === 'select_date') {
      setShowDatePicker(true)
    } else if (value === 'select_theater') {
      if (!bookingState.selectedDate) {
        showError('Please select a date first')
        return
      }
      navigation.navigate('Home', {
        screen: 'TheaterSelection',
        params: { movieName: bookingState.movieName, date: bookingState.selectedDate, returnToChat: true }
      })
    } else if (value === 'select_seats') {
      if (!bookingState.selectedTheater) {
        showError('Please select theater first')
        return
      }
      navigation.navigate('Home', {
        screen: 'SeatSelection',
        params: {
          movieName: bookingState.movieName,
          theater: bookingState.selectedTheater,
          date: bookingState.selectedDate,
          time: bookingState.selectedTime,
          returnToChat: true
        }
      })
    } else if (value === 'proceed_payment') {
      setTimeout(() => {
        navigation.navigate('Home', {
          screen: 'Payment',
          params: {
            bookingDetails: {
              movieId: bookingState.movieId,
              movieName: bookingState.movieName,
              date: bookingState.selectedDate,
              theater: bookingState.selectedTheater,
              time: bookingState.selectedTime,
              seats: bookingState.selectedSeats,
              totalPrice: bookingState.totalPrice
            }
          }
        })
      }, 500)
      const botMsg: IMessage = {
        _id: Math.round(Math.random() * 1000000),
        text: 'âœ… Redirecting to payment...',
        createdAt: new Date(),
        user: { _id: 2, name: 'MovieBot', avatar: require('../assets/images/BotChat.png') },
      }
      setMessages(prev => GiftedChat.append(prev, [botMsg]))
    } else if (value === 'modify') {
      const botMsg: IMessage = {
        _id: Math.round(Math.random() * 1000000),
        text: 'What would you like to modify?',
        createdAt: new Date(),
        user: { _id: 2, name: 'MovieBot', avatar: require('../assets/images/BotChat.png') },
        quickReplies: {
          type: 'radio',
          keepIt: true,
          values: [
            { title: 'ðŸ“… Date', value: 'select_date' },
            { title: 'ðŸŽ­ Theater', value: 'select_theater' },
            { title: 'ðŸª‘ Seats', value: 'select_seats' }
          ]
        }
      }
      setMessages(prev => GiftedChat.append(prev, [botMsg]))
    }
  }, [bookingState])

  const showError = (msg: string) => {
    const botMsg: IMessage = {
      _id: Math.round(Math.random() * 1000000),
      text: `âŒ ${msg}`,
      createdAt: new Date(),
      user: { _id: 2, name: 'MovieBot', avatar: require('../assets/images/BotChat.png') },
    }
    setMessages(prev => GiftedChat.append(prev, [botMsg]))
  }

  const onSend = useCallback((newMessages: IMessage[] = []) => {
    setMessages(previousMessages => GiftedChat.append(previousMessages, newMessages))
    setIsTyping(true)

    setTimeout(() => {
      const userMessage = newMessages[0]?.text?.toLowerCase() || ''
      const { response, newState } = getBotResponse(userMessage, bookingState)

      if (newState) {
        setBookingState(newState)
      }

      const botMessage: IMessage = {
        _id: Math.round(Math.random() * 1000000),
        text: response,
        createdAt: new Date(),
        user: {
          _id: 2,
          name: 'MovieBot',
          avatar: require('../assets/appicon/MovieChatIcon.png'),
        },
      }

      setMessages(previousMessages => GiftedChat.append(previousMessages, [botMessage]))
      setIsTyping(false)
    }, 1500)
  }, [bookingState])

  const getBotResponse = (userMessage: string, state: any): { response: string; newState?: any } => {
    const { step, movieId, movieName } = state

    // Date selection
    if (step === STEPS.DATE && ['1', '2', '3', 'today', 'tomorrow'].some(k => userMessage.includes(k))) {
      const dates = ['Today', 'Tomorrow', 'Day After Tomorrow']
      const selectedDate = userMessage.includes('1') || userMessage.includes('today') ? dates[0] :
        userMessage.includes('2') || userMessage.includes('tomorrow') ? dates[1] : dates[2]

      return {
        response: `Perfect! ${selectedDate} it is! ðŸŽ¬\n\nâ° Select a showtime:\n\n1ï¸âƒ£ 10:00 AM\n2ï¸âƒ£ 01:00 PM\n3ï¸âƒ£ 04:00 PM\n4ï¸âƒ£ 07:00 PM\n5ï¸âƒ£ 10:00 PM`,
        newState: { ...state, selectedDate, step: STEPS.TIME }
      }
    }

    // Time selection
    if (step === STEPS.TIME && ['1', '2', '3', '4', '5'].some(k => userMessage.includes(k))) {
      const times = ['10:00 AM', '01:00 PM', '04:00 PM', '07:00 PM', '10:00 PM']
      const timeIndex = parseInt(userMessage.match(/[1-5]/)?.[0] || '1') - 1
      const selectedTime = times[timeIndex]

      return {
        response: `Great choice! ${selectedTime} â°\n\nðŸŽ­ Select a theater:\n\n1ï¸âƒ£ PVR Cinemas - Screen 1\n2ï¸âƒ£ INOX - Screen 2\n3ï¸âƒ£ Cinepolis - Screen 3`,
        newState: { ...state, selectedTime, step: STEPS.THEATER }
      }
    }

    // Theater selection
    if (step === STEPS.THEATER && ['1', '2', '3'].some(k => userMessage.includes(k))) {
      const theaters = ['PVR Cinemas - Screen 1', 'INOX - Screen 2', 'Cinepolis - Screen 3']
      const theaterIndex = parseInt(userMessage.match(/[1-3]/)?.[0] || '1') - 1
      const selectedTheater = theaters[theaterIndex]

      return {
        response: `Excellent! ${selectedTheater} ðŸŽ­\n\nHow many seats would you like to book?\n(Type a number between 1-10)`,
        newState: { ...state, selectedTheater, step: STEPS.SEATS }
      }
    }

    // Seat count selection
    if (step === STEPS.SEATS && /\d+/.test(userMessage)) {
      const seatCount = parseInt(userMessage.match(/\d+/)?.[0] || '1')
      if (seatCount > 0 && seatCount <= 10) {
        const pricePerSeat = 250
        const totalPrice = seatCount * pricePerSeat

        return {
          response: `Perfect! ${seatCount} seat(s) selected ðŸŽ«\n\nðŸ“ Booking Summary:\nâ€¢ Movie: ${movieName}\nâ€¢ Date: ${state.selectedDate}\nâ€¢ Time: ${state.selectedTime}\nâ€¢ Theater: ${state.selectedTheater}\nâ€¢ Seats: ${seatCount}\nâ€¢ Total: â‚¹${totalPrice}\n\nType 'confirm' to proceed to payment or 'cancel' to start over.`,
          newState: { ...state, selectedSeats: Array(seatCount).fill('A'), totalPrice, step: STEPS.CONFIRM }
        }
      }
    }

    // Confirmation
    if (step === STEPS.CONFIRM) {
      if (userMessage.includes('confirm')) {
        setTimeout(() => {
          console.log("State", state);

          navigation.navigate('Home', { screen: 'Payment', params: { bookingDetails: state } })
        }, 1000)
        return {
          response: `âœ… Booking confirmed! Redirecting to payment...`,
          newState: state
        }
      } else if (userMessage.includes('cancel')) {
        return {
          response: `Booking cancelled. How else can I help you?`,
          newState: { ...state, step: STEPS.DATE }
        }
      }
    }

    // Default responses
    if (userMessage.includes('movie') || userMessage.includes('film')) {
      return { response: 'Great! I can help you find movies. Here are some popular options:\n\nðŸŽ¬ Latest Releases\nðŸŽ­ Action Movies\nðŸ˜‚ Comedy Films\nðŸ’• Romance\n\nWhich genre interests you?' }
    } else if (userMessage.includes('book') || userMessage.includes('ticket')) {
      return { response: 'Perfect! I can help you book tickets. Please tell me which movie you\'d like to watch, or browse movies from the Home screen and tap "Book Now"!' }
    } else if (userMessage.includes('hello') || userMessage.includes('hi')) {
      return { response: 'Hello! Welcome to MovieBot! ðŸŽ¬\n\nI can help you with:\nâ€¢ Finding movies\nâ€¢ Checking showtimes\nâ€¢ Booking tickets\nâ€¢ Theater information\n\nWhat would you like to do?' }
    } else if (userMessage.includes('help')) {
      return { response: 'I\'m here to help! Here\'s what I can do:\n\nðŸŽ¬ Find Movies - Discover new releases and popular films\nâ° Showtimes - Check movie schedules\nðŸŽ« Book Tickets - Reserve your seats\nðŸ“ Theaters - Find nearby cinemas\n\nJust ask me anything!' }
    }

    return { response: 'I understand you\'re looking for movie-related assistance! I can help you with:\n\nâ€¢ Finding movies and showtimes\nâ€¢ Booking tickets\nâ€¢ Theater information\nâ€¢ Movie recommendations\n\nWhat specifically would you like to know?' }
  }

  const renderBubble = useCallback((props: any) => (
    <Bubble
      {...props}
      wrapperStyle={{
        right: {
          backgroundColor: Colors.primary,
          borderRadius: Responsive.radius[20],
          borderBottomRightRadius: 0,
          marginVertical: Responsive.spacing[2],
        },
        left: {
          backgroundColor: Colors.surface,
          borderRadius: Responsive.radius[20],
          borderBottomLeftRadius: 0,
          marginVertical: Responsive.spacing[2],
        },
      }}
      textStyle={{
        right: {
          color: Colors.text.inverse,
          fontSize: Responsive.fontSize[16],
        },
        left: {
          color: Colors.text.primary,
          fontSize: Responsive.fontSize[16],
        },
      }}
    />
  ), [])

  const renderInputToolbar = useCallback((props: any) => (
    <InputToolbar
      {...props}
      containerStyle={styles.inputToolbar}
      primaryStyle={styles.inputPrimary}
    />
  ), [])

  const renderSend = useCallback((props: any) => (
    <Send {...props}>
      <View style={styles.sendButton}>
        <MaterialIcons name="send" size={Responsive.fontSize[20]} color={Colors.text.inverse} />
      </View>
    </Send>
  ), [])

  return (
    <GradientBackground>
      <View style={[styles.container,]}>
        <StatusBar barStyle="light-content" translucent backgroundColor={'transparent'} />

        {/* Header */}
        <View
          style={[styles.header, { paddingTop: insets.top + Responsive.spacing[15] }]}
        >
          <TouchableOpacity
            style={styles.backButton}
            onPress={() => navigation.goBack()}
            activeOpacity={0.8}
          >
            <Feather name="arrow-left" size={Responsive.fontSize[24]} color={Colors.text.inverse} />
          </TouchableOpacity>

          <View style={styles.headerContent}>
            <View style={styles.headerTitle}>
              <Image
                source={require('../assets/images/BotChat.png')}
                style={{ width: Responsive.spacing[45], height: Responsive.spacing[45], }}
                resizeMode='contain'
              />
              <View style={styles.headerText}>
                <Text style={styles.chatTitle}>MovieBot</Text>
                <Text style={styles.chatSubtitle}>Online â€¢ Ready to help</Text>
              </View>
            </View>
          </View>
        </View>

        {/* Chat */}
        <GiftedChat
          messages={messages}
          onSend={onSend}
          onQuickReply={onQuickReply}
          user={{ _id: 1 }}
          renderBubble={renderBubble}
          renderInputToolbar={renderInputToolbar}
          renderSend={renderSend}
          textInputProps={{ placeholder: 'Enter a message' }}
          isTyping={isTyping}
          minInputToolbarHeight={60}
          keyboardAvoidingViewProps={{
            behavior: 'padding',
            keyboardVerticalOffset: totalOffset,
          }}
          listProps={{
            removeClippedSubviews: true,
            maxToRenderPerBatch: 10,
            windowSize: 10,
          }}
        />
      </View>
      <View style={{
        paddingBottom: insets.bottom + 10,
        backgroundColor: 'transparent'
      }} />

      <DatePicker
        modal
        open={showDatePicker}
        date={selectedDate}
        mode="date"
        minimumDate={new Date()}
        onConfirm={handleDateConfirm}
        onCancel={() => setShowDatePicker(false)}
        theme="dark"
      />
    </GradientBackground>
  )
}

export default ChatScreen

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: 'transparent',
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: Responsive.spacing[20],
    paddingBottom: Responsive.spacing[15],
    backgroundColor: Colors.primary,
    elevation: 4,
    shadowColor: Colors.shadow,
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.2,
    shadowRadius: 4,
  },
  backButton: {
    padding: Responsive.padding[8],
    marginRight: Responsive.spacing[10],
  },
  headerContent: {
    flex: 1,
  },
  headerTitle: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  headerText: {
    marginLeft: Responsive.spacing[12],
  },
  chatTitle: {
    fontSize: Responsive.fontSize[18],
    fontWeight: 'bold',
    color: Colors.text.inverse,
  },
  chatSubtitle: {
    fontSize: Responsive.fontSize[12],
    color: Colors.text.inverse,
    opacity: 0.8,
    marginTop: Responsive.spacing[2],
  },
  inputToolbar: {
    backgroundColor: Colors.background,
    // borderTopColor: Colors.border.default,
    paddingHorizontal: Responsive.spacing[10],
    paddingVertical: Responsive.spacing[8],
    borderRadius: Responsive.radius[35],
  },
  inputPrimary: {
    backgroundColor: Colors.background,
    borderRadius: Responsive.radius[35],
    paddingHorizontal: Responsive.padding[10],
    alignItems: 'center',
    justifyContent: 'center',
    borderWidth: 0.5,
    borderColor: Colors.border.default,
  },
  sendButton: {
    backgroundColor: Colors.primary,
    borderRadius: Responsive.radius[20],
    padding: Responsive.padding[10],
    justifyContent: 'center',
    alignItems: 'center',
  },
})